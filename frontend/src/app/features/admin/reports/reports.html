<div class="reports-container">
  <!-- Header -->
  <mat-card class="header-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>assessment</mat-icon>
        Sistema de Reportes
      </mat-card-title>
      <mat-card-subtitle>Genere reportes completos de asistencia, rendimiento académico y estadísticas</mat-card-subtitle>
    </mat-card-header>
  </mat-card>

  <!-- Filtros -->
  <mat-card class="filters-card">
    <mat-card-header>
      <mat-card-title>Filtros</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="filterForm" class="filters-form">
        <!-- Período predefinido -->
        <div class="periodo-buttons">
          <mat-chip-set>
            <mat-chip 
              *ngFor="let periodo of periodoOptions" 
              (click)="onPeriodoChange(periodo.dias)"
              class="periodo-chip">
              {{periodo.label}}
            </mat-chip>
          </mat-chip-set>
        </div>

        <!-- Filtros de fecha -->
        <div class="date-filters">
          <mat-form-field appearance="outline">
            <mat-label>Fecha desde</mat-label>
            <input matInput [matDatepicker]="pickerDesde" formControlName="fecha_desde">
            <mat-datepicker-toggle matSuffix [for]="pickerDesde"></mat-datepicker-toggle>
            <mat-datepicker #pickerDesde></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Fecha hasta</mat-label>
            <input matInput [matDatepicker]="pickerHasta" formControlName="fecha_hasta">
            <mat-datepicker-toggle matSuffix [for]="pickerHasta"></mat-datepicker-toggle>
            <mat-datepicker #pickerHasta></mat-datepicker>
          </mat-form-field>
        </div>

        <!-- Filtros adicionales -->
        <div class="additional-filters">
          <mat-form-field appearance="outline">
            <mat-label>Curso</mat-label>
            <mat-select formControlName="curso_division_id">
              <mat-option value="">Todos los cursos</mat-option>
              <mat-option *ngFor="let curso of cursosOptions" [value]="curso.id">
                {{curso.nombre}}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>ID Usuario (opcional)</mat-label>
            <input matInput type="number" formControlName="usuario_id" placeholder="ID del usuario específico">
          </mat-form-field>
        </div>

        <!-- Botón aplicar filtros -->
        <div class="filter-actions">
          <button mat-raised-button color="primary" (click)="onFilterChange()" [disabled]="!filterForm.valid">
            <mat-icon>filter_list</mat-icon>
            Aplicar Filtros
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Tabs de reportes -->
  <mat-card class="reports-card">
    <mat-tab-group (selectedTabChange)="onTabChange($event.index)" [selectedIndex]="selectedTabIndex">
      
      <!-- TAB: Asistencia -->
      <mat-tab label="Asistencia">
        <ng-template matTabContent>
          <div class="tab-content">
            <!-- Acciones de exportación -->
            <div class="export-actions">
              <button mat-stroked-button (click)="exportAttendanceExcel()" [disabled]="loading">
                <mat-icon>download</mat-icon>
                Exportar Excel
              </button>
              <button mat-stroked-button (click)="exportAttendancePDF()" [disabled]="loading">
                <mat-icon>picture_as_pdf</mat-icon>
                Exportar PDF
              </button>
            </div>

            <div class="content-grid">
              <!-- Gráfico -->
              <div class="chart-container">
                <h3>Distribución de Asistencia</h3>
                <canvas #attendanceChart></canvas>
              </div>

              <!-- Datos en tabla -->
              <div class="table-container">
                <h3>Registros de Asistencia ({{attendanceData.length}})</h3>
                
                @if (loading) {
                  <div class="loading-container">
                    <mat-spinner diameter="40"></mat-spinner>
                    <p>Cargando reporte...</p>
                  </div>
                } @else {
                  <div class="table-wrapper">
                    <table mat-table [dataSource]="attendanceData" class="attendance-table">
                      <!-- Nombre -->
                      <ng-container matColumnDef="nombre">
                        <th mat-header-cell *matHeaderCellDef>Nombre</th>
                        <td mat-cell *matCellDef="let record">{{record.usuario.nombre}}</td>
                      </ng-container>

                      <!-- Apellido -->
                      <ng-container matColumnDef="apellido">
                        <th mat-header-cell *matHeaderCellDef>Apellido</th>
                        <td mat-cell *matCellDef="let record">{{record.usuario.apellido}}</td>
                      </ng-container>

                      <!-- DNI -->
                      <ng-container matColumnDef="dni">
                        <th mat-header-cell *matHeaderCellDef>DNI</th>
                        <td mat-cell *matCellDef="let record">{{record.usuario.dni}}</td>
                      </ng-container>

                      <!-- Fecha -->
                      <ng-container matColumnDef="fecha">
                        <th mat-header-cell *matHeaderCellDef>Fecha</th>
                        <td mat-cell *matCellDef="let record">{{record.fecha}}</td>
                      </ng-container>

                      <!-- Estado -->
                      <ng-container matColumnDef="estado">
                        <th mat-header-cell *matHeaderCellDef>Estado</th>
                        <td mat-cell *matCellDef="let record">
                          <span class="estado-badge" [ngClass]="getEstadoClass(record.estado)">
                            {{record.estado | titlecase}}
                          </span>
                        </td>
                      </ng-container>

                      <!-- Ingreso -->
                      <ng-container matColumnDef="ingreso">
                        <th mat-header-cell *matHeaderCellDef>Ingreso</th>
                        <td mat-cell *matCellDef="let record">{{formatTime(record.ingreso)}}</td>
                      </ng-container>

                      <!-- Egreso -->
                      <ng-container matColumnDef="egreso">
                        <th mat-header-cell *matHeaderCellDef>Egreso</th>
                        <td mat-cell *matCellDef="let record">{{formatTime(record.egreso)}}</td>
                      </ng-container>

                      <!-- Acciones -->
                      <ng-container matColumnDef="acciones">
                        <th mat-header-cell *matHeaderCellDef>Tardanza</th>
                        <td mat-cell *matCellDef="let record">
                          @if (record.minutos_tardanza && record.minutos_tardanza > 0) {
                            <span class="tardanza-info">{{record.minutos_tardanza}} min</span>
                          } @else {
                            <span>-</span>
                          }
                        </td>
                      </ng-container>

                      <tr mat-header-row *matHeaderRowDef="attendanceColumns"></tr>
                      <tr mat-row *matRowDef="let row; columns: attendanceColumns;"></tr>
                    </table>
                  </div>
                }
              </div>
            </div>
          </div>
        </ng-template>
      </mat-tab>

      <!-- TAB: Rendimiento Académico -->
      <mat-tab label="Rendimiento Académico">
        <ng-template matTabContent>
          <div class="tab-content">
            <!-- Acciones de exportación -->
            <div class="export-actions">
              <button mat-stroked-button (click)="exportPerformanceExcel()" [disabled]="loading">
                <mat-icon>download</mat-icon>
                Exportar Excel
              </button>
              <button mat-stroked-button (click)="exportPerformancePDF()" [disabled]="loading">
                <mat-icon>picture_as_pdf</mat-icon>
                Exportar PDF
              </button>
            </div>

            <div class="content-grid">
              <!-- Gráfico -->
              <div class="chart-container">
                <h3>Distribución de Rendimiento</h3>
                <canvas #performanceChart></canvas>
              </div>

              <!-- Datos en tabla -->
              <div class="table-container">
                <h3>Rendimiento por Estudiante ({{performanceData.length}})</h3>
                
                @if (loading) {
                  <div class="loading-container">
                    <mat-spinner diameter="40"></mat-spinner>
                    <p>Cargando reporte...</p>
                  </div>
                } @else {
                  <div class="table-wrapper">
                    <table mat-table [dataSource]="performanceData" class="performance-table">
                      <!-- Nombre -->
                      <ng-container matColumnDef="nombre">
                        <th mat-header-cell *matHeaderCellDef>Nombre</th>
                        <td mat-cell *matCellDef="let record">{{record.estudiante.nombre}}</td>
                      </ng-container>

                      <!-- Apellido -->
                      <ng-container matColumnDef="apellido">
                        <th mat-header-cell *matHeaderCellDef>Apellido</th>
                        <td mat-cell *matCellDef="let record">{{record.estudiante.apellido}}</td>
                      </ng-container>

                      <!-- DNI -->
                      <ng-container matColumnDef="dni">
                        <th mat-header-cell *matHeaderCellDef>DNI</th>
                        <td mat-cell *matCellDef="let record">{{record.estudiante.dni}}</td>
                      </ng-container>

                      <!-- Curso -->
                      <ng-container matColumnDef="curso">
                        <th mat-header-cell *matHeaderCellDef>Curso</th>
                        <td mat-cell *matCellDef="let record">{{record.curso}}</td>
                      </ng-container>

                      <!-- Promedio General -->
                      <ng-container matColumnDef="promedio_general">
                        <th mat-header-cell *matHeaderCellDef>Promedio</th>
                        <td mat-cell *matCellDef="let record">
                          <span class="promedio-badge" 
                                [class.promedio-alto]="record.promedio_general >= 8"
                                [class.promedio-medio]="record.promedio_general >= 6 && record.promedio_general < 8"
                                [class.promedio-bajo]="record.promedio_general < 6">
                            {{record.promedio_general.toFixed(2)}}
                          </span>
                        </td>
                      </ng-container>

                      <!-- Total Notas -->
                      <ng-container matColumnDef="total_notas">
                        <th mat-header-cell *matHeaderCellDef>Total Notas</th>
                        <td mat-cell *matCellDef="let record">{{record.total_notas}}</td>
                      </ng-container>

                      <!-- Acciones -->
                      <ng-container matColumnDef="acciones">
                        <th mat-header-cell *matHeaderCellDef>Materias</th>
                        <td mat-cell *matCellDef="let record">
                          <button mat-icon-button [matTooltip]="'Ver detalles de ' + record.materias.length + ' materias'">
                            <mat-icon>visibility</mat-icon>
                          </button>
                        </td>
                      </ng-container>

                      <tr mat-header-row *matHeaderRowDef="performanceColumns"></tr>
                      <tr mat-row *matRowDef="let row; columns: performanceColumns;"></tr>
                    </table>
                  </div>
                }
              </div>
            </div>
          </div>
        </ng-template>
      </mat-tab>

      <!-- TAB: Estadísticas -->
      <mat-tab label="Estadísticas">
        <ng-template matTabContent>
          <div class="tab-content">
            @if (loading) {
              <div class="loading-container">
                <mat-spinner diameter="40"></mat-spinner>
                <p>Cargando estadísticas...</p>
              </div>
            } @else if (statisticsData) {
              <div class="statistics-grid">
                <!-- Tarjetas de resumen -->
                <div class="summary-cards">
                  <mat-card class="stat-card">
                    <mat-card-header>
                      <mat-card-title>Asistencia Total</mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                      <div class="stat-number">{{statisticsData.asistencia.porcentajes.asistencia}}%</div>
                      <div class="stat-detail">{{statisticsData.asistencia.conteos.total_registros}} registros</div>
                    </mat-card-content>
                  </mat-card>

                  <mat-card class="stat-card">
                    <mat-card-header>
                      <mat-card-title>Ausencias</mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                      <div class="stat-number">{{statisticsData.asistencia.porcentajes.ausencias}}%</div>
                      <div class="stat-detail">{{statisticsData.asistencia.conteos.ausentes}} ausencias</div>
                    </mat-card-content>
                  </mat-card>

                  <mat-card class="stat-card">
                    <mat-card-header>
                      <mat-card-title>Tardanzas</mat-card-title>
                    </mat-card-header>
                    <mat-card-content>
                      <div class="stat-number">{{statisticsData.asistencia.porcentajes.tardanzas}}%</div>
                      <div class="stat-detail">{{statisticsData.asistencia.conteos.tardanzas}} tardanzas</div>
                    </mat-card-content>
                  </mat-card>

                  @if (statisticsData.rendimiento) {
                    <mat-card class="stat-card">
                      <mat-card-header>
                        <mat-card-title>Promedio General</mat-card-title>
                      </mat-card-header>
                      <mat-card-content>
                        <div class="stat-number">{{statisticsData.rendimiento.promedio_general}}</div>
                        <div class="stat-detail">{{statisticsData.rendimiento.total_estudiantes}} estudiantes</div>
                      </mat-card-content>
                    </mat-card>
                  }
                </div>

                <!-- Gráfico -->
                <div class="chart-container">
                  <h3>Tendencia Semanal</h3>
                  <canvas #statisticsChart></canvas>
                </div>

                <!-- Detalles de rendimiento -->
                @if (statisticsData.rendimiento) {
                  <div class="performance-breakdown">
                    <h3>Distribución de Rendimiento</h3>
                    <div class="performance-stats">
                      <div class="performance-stat">
                        <span class="performance-label">Sobresalientes:</span>
                        <span class="performance-value">{{statisticsData.rendimiento.estudiantes_sobresalientes}}</span>
                      </div>
                      <div class="performance-stat">
                        <span class="performance-label">Regulares:</span>
                        <span class="performance-value">{{statisticsData.rendimiento.estudiantes_regulares}}</span>
                      </div>
                      <div class="performance-stat">
                        <span class="performance-label">En Riesgo:</span>
                        <span class="performance-value">{{statisticsData.rendimiento.estudiantes_en_riesgo}}</span>
                      </div>
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        </ng-template>
      </mat-tab>

    </mat-tab-group>
  </mat-card>

  <!-- Loading overlay -->
  @if (loading) {
    <div class="loading-overlay">
      <mat-spinner diameter="50"></mat-spinner>
    </div>
  }
</div>
