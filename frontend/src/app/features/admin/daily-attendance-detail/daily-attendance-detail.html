<div class="daily-attendance-container" *ngIf="!isLoading; else loadingTemplate">
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <button mat-icon-button (click)="backToDivision()" class="back-button">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="header-text">
        <h1>Asistencia {{ formatDate(fecha) }}</h1>
        <p>{{ attendanceDetail.division.curso_nombre }} {{ attendanceDetail.division.nombre }}</p>
      </div>
      <div class="header-actions">
        <button mat-raised-button color="primary" (click)="exportAttendanceReport()">
          <mat-icon>download</mat-icon>
          Exportar Reporte
        </button>
        <button mat-raised-button 
                *ngIf="attendanceDetail.estudiantes_ausentes.length > 0"
                (click)="sendAbsentNotifications()">
          <mat-icon>notifications</mat-icon>
          Notificar Ausentes
        </button>
      </div>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="summary-cards">
    <mat-card class="summary-card total">
      <mat-card-content>
        <mat-icon class="summary-icon">group</mat-icon>
        <div class="summary-info">
          <h3>{{ attendanceDetail.estadisticas.total_estudiantes }}</h3>
          <p>Total Estudiantes</p>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card present">
      <mat-card-content>
        <mat-icon class="summary-icon">check_circle</mat-icon>
        <div class="summary-info">
          <h3>{{ attendanceDetail.estadisticas.presentes }}</h3>
          <p>Presentes</p>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card absent">
      <mat-card-content>
        <mat-icon class="summary-icon">cancel</mat-icon>
        <div class="summary-info">
          <h3>{{ attendanceDetail.estadisticas.ausentes }}</h3>
          <p>Ausentes</p>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card late">
      <mat-card-content>
        <mat-icon class="summary-icon">schedule</mat-icon>
        <div class="summary-info">
          <h3>{{ attendanceDetail.estadisticas.tarde }}</h3>
          <p>Tardanzas</p>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="summary-card percentage" [ngClass]="getAttendancePercentageClass()">
      <mat-card-content>
        <mat-icon class="summary-icon">trending_up</mat-icon>
        <div class="summary-info">
          <h3>{{ attendanceDetail.estadisticas.porcentaje_asistencia }}%</h3>
          <p>Porcentaje de Asistencia</p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Content Cards -->
  <div class="content-grid">
    <!-- Attendance Records -->
    <mat-card class="content-card records-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>access_time</mat-icon>
          Registros de Asistencia ({{ attendanceDetail.registros.length }})
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="table-container" *ngIf="attendanceDetail.registros.length > 0; else noRecords">
          <table mat-table [dataSource]="attendanceDetail.registros" class="attendance-table">
            <ng-container matColumnDef="estudiante">
              <th mat-header-cell *matHeaderCellDef>Estudiante</th>
              <td mat-cell *matCellDef="let registro">
                <div class="student-info clickable" (click)="viewStudentDetail(registro.estudiante)">
                  <div class="student-name">{{ registro.estudiante.nombre }} {{ registro.estudiante.apellido }}</div>
                  <div class="student-dni">DNI: {{ registro.estudiante.dni }}</div>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="tipo">
              <th mat-header-cell *matHeaderCellDef>Tipo</th>
              <td mat-cell *matCellDef="let registro">
                <div class="tipo-container">
                  <mat-icon class="tipo-icon">{{ getTipoIcon(registro.tipo) }}</mat-icon>
                  <span class="tipo-text">{{ registro.tipo | titlecase }}</span>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="hora">
              <th mat-header-cell *matHeaderCellDef>Hora</th>
              <td mat-cell *matCellDef="let registro">
                <span class="time-badge">{{ formatTime(registro.hora) }}</span>
              </td>
            </ng-container>

            <ng-container matColumnDef="dispositivo">
              <th mat-header-cell *matHeaderCellDef>Dispositivo</th>
              <td mat-cell *matCellDef="let registro">
                <div class="device-info">
                  <mat-icon>fingerprint</mat-icon>
                  <span>{{ registro.dispositivo || 'No especificado' }}</span>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="estado">
              <th mat-header-cell *matHeaderCellDef>Estado</th>
              <td mat-cell *matCellDef="let registro">
                <span class="estado-badge" [ngClass]="getEstadoClass(registro.estado)">
                  <mat-icon>{{ getEstadoIcon(registro.estado) }}</mat-icon>
                  {{ registro.estado | titlecase }}
                </span>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="registrosColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: registrosColumns;" class="clickable-row"></tr>
          </table>
        </div>

        <ng-template #noRecords>
          <div class="empty-state">
            <mat-icon>access_time_filled</mat-icon>
            <p>No hay registros de asistencia para este día</p>
          </div>
        </ng-template>
      </mat-card-content>
    </mat-card>

    <!-- Absent Students -->
    <mat-card class="content-card absent-card" *ngIf="attendanceDetail.estudiantes_ausentes.length > 0">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>person_off</mat-icon>
          Estudiantes Ausentes ({{ attendanceDetail.estudiantes_ausentes.length }})
        </mat-card-title>
        <div class="card-actions">
          <button mat-icon-button matTooltip="Notificar ausentes" (click)="sendAbsentNotifications()">
            <mat-icon>notifications</mat-icon>
          </button>
        </div>
      </mat-card-header>
      <mat-card-content>
        <div class="absent-list">
          <div class="absent-item" *ngFor="let student of attendanceDetail.estudiantes_ausentes">
            <div class="student-info" (click)="viewStudentDetail(student)">
              <div class="student-avatar">
                <mat-icon>person</mat-icon>
              </div>
              <div class="student-details">
                <div class="student-name">{{ student.nombre }} {{ student.apellido }}</div>
                <div class="student-dni">DNI: {{ student.dni }}</div>
              </div>
            </div>
            <div class="absent-actions">
              <button mat-icon-button 
                      matTooltip="Marcar llegada tarde"
                      (click)="markLateArrival(student)">
                <mat-icon>schedule</mat-icon>
              </button>
              <button mat-icon-button 
                      matTooltip="Marcar asistencia manual"
                      (click)="markManualAttendance(student)">
                <mat-icon>edit</mat-icon>
              </button>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- No Absents Message -->
    <mat-card class="content-card no-absents-card" *ngIf="attendanceDetail.estudiantes_ausentes.length === 0">
      <mat-card-content>
        <div class="celebration-state">
          <mat-icon>celebration</mat-icon>
          <h3>¡Excelente!</h3>
          <p>Todos los estudiantes están presentes hoy</p>
          <div class="achievement-badge">
            <mat-icon>star</mat-icon>
            <span>100% Asistencia</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>

<ng-template #loadingTemplate>
  <div class="loading-container">
    <mat-spinner diameter="60" color="primary"></mat-spinner>
    <p class="loading-text">Cargando detalles de asistencia...</p>
  </div>
</ng-template>