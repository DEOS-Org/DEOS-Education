<div class="mensajeria-container">
  <!-- Header -->
  <div class="page-header">
    <h1>Mensajes</h1>
    
    <div class="vista-selector">
      <button mat-stroked-button 
              [color]="vistaActual === 'conversaciones' ? 'primary' : ''"
              (click)="cambiarVista('conversaciones')">
        <mat-icon>chat</mat-icon>
        Conversaciones
      </button>
      <button mat-stroked-button 
              [color]="vistaActual === 'grupos' ? 'primary' : ''"
              (click)="cambiarVista('grupos')">
        <mat-icon>group</mat-icon>
        Grupos
      </button>
    </div>
  </div>

  <div class="chat-layout">
    
    <!-- Panel izquierdo - Lista de conversaciones/grupos -->
    <div class="sidebar">
      
      <!-- Vista de conversaciones -->
      <div *ngIf="vistaActual === 'conversaciones'" class="conversaciones-panel">
        <div class="panel-header">
          <h3>Conversaciones Recientes</h3>
          <button mat-icon-button (click)="mostrarNuevaConversacion = true"
                  matTooltip="Nueva conversación">
            <mat-icon>add</mat-icon>
          </button>
        </div>

        <div class="conversaciones-lista" *ngIf="!isLoading; else loadingSidebar">
          <mat-list>
            <mat-list-item *ngFor="let conversacion of conversaciones"
                          (click)="seleccionarConversacion(conversacion)"
                          [class.selected]="conversacionActual?.otroUsuarioId === conversacion.otro_usuario_id">
              
              <div matListItemAvatar>
                <mat-icon class="avatar-icon">person</mat-icon>
              </div>
              
              <div matListItemTitle>
                {{ conversacion.nombre }} {{ conversacion.apellido }}
              </div>
              
              <div matListItemLine class="mensaje-preview">
                {{ conversacion.ultimo_mensaje || 'Sin mensajes' }}
              </div>
              
              <div matListItemMeta class="conversacion-meta">
                <span class="fecha">{{ formatearFecha(conversacion.ultima_actividad) }}</span>
                <mat-chip *ngIf="conversacion.mensajes_no_leidos > 0" 
                         class="badge-no-leidos">
                  {{ conversacion.mensajes_no_leidos }}
                </mat-chip>
              </div>
            </mat-list-item>
          </mat-list>
        </div>

        <!-- Modal nueva conversación -->
        <div class="nueva-conversacion-modal" *ngIf="mostrarNuevaConversacion">
          <mat-card>
            <mat-card-header>
              <mat-card-title>Nueva Conversación</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Buscar usuario</mat-label>
                <input matInput 
                       [formControl]="busquedaUsuarioControl"
                       [matAutocomplete]="autoUsuario"
                       placeholder="Escribe el nombre del usuario...">
                <mat-icon matSuffix>search</mat-icon>
                <mat-autocomplete #autoUsuario="matAutocomplete" 
                                  [displayWith]="mostrarUsuario"
                                  (optionSelected)="onUsuarioSeleccionado($event)">
                  <mat-option *ngFor="let usuario of usuariosFiltrados$ | async" [value]="usuario">
                    <div class="usuario-option">
                      <mat-icon class="usuario-icon">person</mat-icon>
                      <div class="usuario-info">
                        <span class="usuario-nombre">{{ usuario.nombre }} {{ usuario.apellido }}</span>
                        <span class="usuario-rol">{{ usuario.rol }} - {{ usuario.email }}</span>
                      </div>
                    </div>
                  </mat-option>
                </mat-autocomplete>
              </mat-form-field>
            </mat-card-content>
            <mat-card-actions align="end">
              <button mat-button (click)="mostrarNuevaConversacion = false; busquedaUsuarioControl.reset()">Cancelar</button>
            </mat-card-actions>
          </mat-card>
        </div>
      </div>

      <!-- Vista de grupos -->
      <div *ngIf="vistaActual === 'grupos'" class="grupos-panel">
        <div class="panel-header">
          <h3>Grupos de Chat</h3>
          <button mat-icon-button (click)="mostrarNuevoGrupo = true"
                  matTooltip="Nuevo grupo">
            <mat-icon>add</mat-icon>
          </button>
        </div>

        <div class="grupos-lista" *ngIf="!isLoading; else loadingSidebar">
          <mat-list>
            <mat-list-item *ngFor="let grupo of grupos"
                          (click)="seleccionarGrupo(grupo)"
                          [class.selected]="conversacionActual?.id === grupo.id && conversacionActual?.tipo === 'grupo'">
              
              <div matListItemAvatar>
                <mat-icon class="avatar-icon">group</mat-icon>
              </div>
              
              <div matListItemTitle>
                {{ grupo.nombre }}
              </div>
              
              <div matListItemLine>
                {{ grupo.descripcion || 'Sin descripción' }}
              </div>
              
              <div matListItemMeta>
                <mat-chip class="tipo-grupo">{{ grupo.tipo }}</mat-chip>
              </div>
            </mat-list-item>
          </mat-list>
        </div>

        <!-- Modal nuevo grupo -->
        <div class="nuevo-grupo-modal" *ngIf="mostrarNuevoGrupo">
          <mat-card>
            <mat-card-header>
              <mat-card-title>Nuevo Grupo</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <form [formGroup]="grupoForm">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Nombre del grupo</mat-label>
                  <input matInput formControlName="nombre" maxlength="100">
                  <mat-error *ngIf="grupoForm.get('nombre')?.hasError('required')">
                    El nombre es obligatorio
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Descripción</mat-label>
                  <textarea matInput formControlName="descripcion" rows="3" maxlength="255"></textarea>
                </mat-form-field>

                <div class="miembros-section">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Buscar miembros</mat-label>
                    <input matInput 
                           [formControl]="busquedaMiembrosControl"
                           [matAutocomplete]="autoMiembros"
                           placeholder="Escribe el nombre del usuario...">
                    <mat-icon matSuffix>search</mat-icon>
                    <mat-autocomplete #autoMiembros="matAutocomplete" 
                                      [displayWith]="mostrarUsuario"
                                      (optionSelected)="agregarMiembro($event)">
                      <mat-option *ngFor="let usuario of miembrosFiltrados$ | async" [value]="usuario">
                        <div class="usuario-option">
                          <mat-icon class="usuario-icon">person</mat-icon>
                          <div class="usuario-info">
                            <span class="usuario-nombre">{{ usuario.nombre }} {{ usuario.apellido }}</span>
                            <span class="usuario-rol">{{ usuario.rol }}</span>
                          </div>
                        </div>
                      </mat-option>
                    </mat-autocomplete>
                  </mat-form-field>

                  <div class="miembros-seleccionados" *ngIf="miembrosSeleccionados.length > 0">
                    <p class="miembros-label">Miembros seleccionados:</p>
                    <mat-chip-set>
                      <mat-chip *ngFor="let miembro of miembrosSeleccionados" 
                                [removable]="true"
                                (removed)="removerMiembro(miembro)">
                        <mat-icon class="chip-icon">person</mat-icon>
                        {{ miembro.nombre }} {{ miembro.apellido }}
                        <mat-icon matChipRemove>cancel</mat-icon>
                      </mat-chip>
                    </mat-chip-set>
                  </div>
                  
                  <mat-error *ngIf="grupoForm.get('miembrosIds')?.hasError('required') && grupoForm.get('miembrosIds')?.touched">
                    Debe seleccionar al menos un miembro
                  </mat-error>
                </div>
              </form>
            </mat-card-content>
            <mat-card-actions align="end">
              <button mat-button (click)="cancelarNuevoGrupo()">Cancelar</button>
              <button mat-raised-button color="primary" 
                      (click)="crearGrupo()"
                      [disabled]="grupoForm.invalid || isLoading">
                Crear Grupo
              </button>
            </mat-card-actions>
          </mat-card>
        </div>
      </div>

      <ng-template #loadingSidebar>
        <div class="loading-sidebar">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Cargando...</p>
        </div>
      </ng-template>
    </div>

    <!-- Panel principal - Chat -->
    <div class="chat-panel">
      
      <!-- Header del chat -->
      <div class="chat-header" *ngIf="conversacionActual">
        <div class="chat-info">
          <mat-icon>{{ conversacionActual.tipo === 'grupo' ? 'group' : 'person' }}</mat-icon>
          <div class="chat-details">
            <h3>{{ conversacionActual.nombre }}</h3>
            <span class="chat-subtitle">
              {{ conversacionActual.tipo === 'grupo' ? 'Grupo' : 'Conversación directa' }}
            </span>
          </div>
        </div>
        
        <div class="chat-actions">
          <button mat-icon-button matTooltip="Información">
            <mat-icon>info</mat-icon>
          </button>
        </div>
      </div>

      <!-- Área de mensajes -->
      <div class="mensajes-container" *ngIf="conversacionActual; else noConversation">
        <div class="mensajes-lista">
          <div *ngFor="let mensaje of mensajes" 
               class="mensaje-item"
               [ngClass]="{'mensaje-propio': mensaje.usuario_emisor_id === getCurrentUserId(), 'mensaje-otro': mensaje.usuario_emisor_id !== getCurrentUserId()}">
            
            <div class="mensaje-bubble" [ngStyle]="getMensajeEstilo(mensaje)">
              <div class="mensaje-header" *ngIf="conversacionActual.tipo === 'grupo' && mensaje.usuario_emisor_id !== getCurrentUserId()">
                <span class="emisor-nombre">{{ mensaje.UsuarioEmisor?.nombre }} {{ mensaje.UsuarioEmisor?.apellido }}</span>
              </div>
              
              <div class="mensaje-contenido">
                {{ mensaje.contenido }}
              </div>
              
              <div class="mensaje-footer">
                <span class="mensaje-hora">{{ formatearFecha(mensaje.fecha_creacion) }}</span>
                <mat-icon *ngIf="mensaje.editado" class="editado-icon" matTooltip="Editado">edit</mat-icon>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Área de escritura -->
      <div class="mensaje-input" *ngIf="conversacionActual">
        <form [formGroup]="mensajeForm" (ngSubmit)="enviarMensaje()" class="input-form">
          <mat-form-field appearance="outline" class="mensaje-field">
            <input matInput 
                   formControlName="contenido"
                   placeholder="Escribe un mensaje..."
                   maxlength="1000"
                   (keyup.enter)="enviarMensaje()">
            <mat-error *ngIf="mensajeForm.get('contenido')?.hasError('required')">
              Escribe un mensaje
            </mat-error>
          </mat-form-field>
          
          <button mat-fab color="primary" type="submit" 
                  [disabled]="mensajeForm.invalid"
                  class="enviar-btn">
            <mat-icon>send</mat-icon>
          </button>
        </form>
      </div>

      <!-- Estado sin conversación -->
      <ng-template #noConversation>
        <div class="no-conversation">
          <mat-icon class="no-conversation-icon">chat_bubble_outline</mat-icon>
          <h3>Selecciona una conversación</h3>
          <p>Elige una conversación de la lista o crea una nueva para comenzar a chatear.</p>
        </div>
      </ng-template>
    </div>
  </div>
</div>