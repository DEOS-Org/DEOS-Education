<div class="professor-grades-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <mat-icon>grade</mat-icon>
        Gestión de Calificaciones
      </h1>
      <div class="header-actions">
        <button mat-raised-button color="primary" (click)="selectedTabIndex = 1">
          <mat-icon>add</mat-icon>
          Nueva Calificación
        </button>
        <button mat-raised-button color="primary" (click)="refreshData()">
          <mat-icon>refresh</mat-icon>
          Actualizar
        </button>
        <button mat-raised-button color="accent" (click)="exportGrades()">
          <mat-icon>download</mat-icon>
          Exportar
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Cargando calificaciones...</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading" class="main-content">
    <!-- Statistics Cards -->
    <div class="stats-grid">
      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-icon primary">
            <mat-icon>people</mat-icon>
          </div>
          <div class="stat-info">
            <h3>{{ gradeStats.totalStudents }}</h3>
            <p>Estudiantes Total</p>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-icon success">
            <mat-icon>check_circle</mat-icon>
          </div>
          <div class="stat-info">
            <h3>{{ gradeStats.gradedStudents }}</h3>
            <p>Calificados</p>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-icon warn">
            <mat-icon>pending</mat-icon>
          </div>
          <div class="stat-info">
            <h3>{{ gradeStats.pendingGrades }}</h3>
            <p>Pendientes</p>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-icon accent">
            <mat-icon>trending_up</mat-icon>
          </div>
          <div class="stat-info">
            <h3>{{ gradeStats.averageGrade | number:'1.1-1' }}</h3>
            <p>Promedio General</p>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-icon primary">
            <mat-icon>star</mat-icon>
          </div>
          <div class="stat-info">
            <h3>{{ gradeStats.passRate | number:'1.0-0' }}%</h3>
            <p>Tasa de Aprobación</p>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-icon error">
            <mat-icon>person_off</mat-icon>
          </div>
          <div class="stat-info">
            <h3>{{ gradeStats.absentStudents }}</h3>
            <p>Ausentes</p>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Tabs Section -->
    <mat-tab-group [(selectedIndex)]="selectedTabIndex" class="content-tabs">
      <!-- Grades Management Tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon>list</mat-icon>
          <span>Calificaciones</span>
        </ng-template>

        <div class="tab-content">
          <!-- Filters Card -->
          <mat-card class="filters-card">
            <mat-card-content>
              <form [formGroup]="filtersForm" class="filters-form">
                <mat-form-field appearance="outline" class="search-field">
                  <mat-label>Buscar estudiante</mat-label>
                  <input matInput formControlName="searchTerm" placeholder="Nombre o DNI...">
                  <mat-icon matPrefix>search</mat-icon>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Clase</mat-label>
                  <mat-select formControlName="selectedClass">
                    <mat-option value="all">Todas las clases</mat-option>
                    <mat-option *ngFor="let class of myClasses" [value]="class.id">
                      {{ getClassDisplayName(class) }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Tipo de Evaluación</mat-label>
                  <mat-select formControlName="evaluationType">
                    <mat-option *ngFor="let type of evaluationTypes" [value]="type.value">
                      {{ type.label }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Trimestre</mat-label>
                  <mat-select formControlName="trimester">
                    <mat-option *ngFor="let trimester of trimesters" [value]="trimester.value">
                      {{ trimester.label }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>

              </form>
            </mat-card-content>
          </mat-card>

          <!-- Grades Table -->
          <mat-card class="table-card">
            <mat-card-content>
              <div class="table-container">
                <table mat-table [dataSource]="gradesDataSource" matSort class="grades-table">
                  <!-- Student Name Column -->
                  <ng-container matColumnDef="estudiante">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Estudiante</th>
                    <td mat-cell *matCellDef="let grade">
                      <div class="student-info">
                        <div class="student-avatar">
                          <mat-icon>person</mat-icon>
                        </div>
                        <div class="student-details">
                          <div class="student-name">{{ grade.estudiante.nombre }} {{ grade.estudiante.apellido }}</div>
                          <div class="student-dni">DNI: {{ grade.estudiante.numero_documento }}</div>
                        </div>
                      </div>
                    </td>
                  </ng-container>

                  <!-- Evaluation Type Column -->
                  <ng-container matColumnDef="tipoEvaluacion">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Tipo</th>
                    <td mat-cell *matCellDef="let grade">
                      <mat-chip class="evaluation-chip">{{ grade.tipoEvaluacion }}</mat-chip>
                    </td>
                  </ng-container>

                  <!-- Description Column -->
                  <ng-container matColumnDef="descripcion">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Descripción</th>
                    <td mat-cell *matCellDef="let grade">
                      {{ grade.descripcion }}
                    </td>
                  </ng-container>

                  <!-- Grade Column -->
                  <ng-container matColumnDef="calificacion">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Nota</th>
                    <td mat-cell *matCellDef="let grade">
                      <div class="grade-display" [style.color]="getGradeColor(grade.calificacion)">
                        <span class="grade-value">{{ grade.calificacion }}</span>
                        <span class="grade-max">/{{ grade.calificacionMaxima }}</span>
                      </div>
                    </td>
                  </ng-container>

                  <!-- Percentage Column -->
                  <ng-container matColumnDef="percentage">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Porcentaje</th>
                    <td mat-cell *matCellDef="let grade">
                      <div class="percentage-display">
                        <span>{{ getPercentage(grade) }}%</span>
                        <div class="percentage-bar">
                          <div class="percentage-fill" 
                               [style.width.%]="getPercentage(grade)"
                               [style.background-color]="getGradeColor(grade.calificacion)">
                          </div>
                        </div>
                      </div>
                    </td>
                  </ng-container>

                  <!-- Date Column -->
                  <ng-container matColumnDef="fechaEvaluacion">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha</th>
                    <td mat-cell *matCellDef="let grade">{{ grade.fechaEvaluacion | date:'dd/MM/yyyy' }}</td>
                  </ng-container>

                  <!-- Trimester Column -->
                  <ng-container matColumnDef="trimestre">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Trimestre</th>
                    <td mat-cell *matCellDef="let grade">
                      <mat-chip color="primary" selected>
                        {{ grade.trimestre }}° Trimestre
                      </mat-chip>
                    </td>
                  </ng-container>

                  <!-- Actions Column -->
                  <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef>Acciones</th>
                    <td mat-cell *matCellDef="let grade">
                      <button mat-icon-button color="primary" 
                              (click)="editGrade(grade)"
                              matTooltip="Editar calificación">
                        <mat-icon>edit</mat-icon>
                      </button>
                      <button mat-icon-button color="warn" 
                              (click)="deleteGrade(grade)"
                              matTooltip="Eliminar calificación">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                  <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                </table>

                <mat-paginator [pageSizeOptions]="[10, 25, 50, 100]" 
                               showFirstLastButtons
                               aria-label="Seleccionar página de calificaciones">
                </mat-paginator>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- New Grade Tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon>add</mat-icon>
          <span>Nueva Calificación</span>
        </ng-template>

        <div class="tab-content">
          <!-- Grade creation form will be shown here via the edit panel -->
          <div class="new-grade-info">
            <mat-card>
              <mat-card-content>
                <div class="info-content">
                  <mat-icon>info</mat-icon>
                  <p>Utilice el panel de la derecha para registrar una nueva calificación.</p>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </div>
      </mat-tab>

      <!-- Analytics Tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon>analytics</mat-icon>
          <span>Análisis</span>
        </ng-template>

        <div class="tab-content">
          <div class="charts-grid">
            <mat-card class="chart-card">
              <mat-card-header>
                <mat-card-title>Distribución de Calificaciones</mat-card-title>
                <mat-card-subtitle>Resumen general del rendimiento</mat-card-subtitle>
              </mat-card-header>
              <mat-card-content>
                <div class="chart-container">
                  <canvas id="gradesDistributionChart"></canvas>
                </div>
              </mat-card-content>
            </mat-card>

            <mat-card class="summary-card">
              <mat-card-header>
                <mat-card-title>Resumen Estadístico</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="summary-stats">
                  <div class="summary-item">
                    <div class="summary-label">Calificación Más Alta</div>
                    <div class="summary-value success">
                      {{ getMaxGrade() }}
                    </div>
                  </div>
                  <div class="summary-item">
                    <div class="summary-label">Calificación Más Baja</div>
                    <div class="summary-value error">
                      {{ getMinGrade() }}
                    </div>
                  </div>
                  <div class="summary-item">
                    <div class="summary-label">Promedio General</div>
                    <div class="summary-value primary">
                      {{ gradeStats.averageGrade | number:'1.1-1' }}
                    </div>
                  </div>
                  <div class="summary-item">
                    <div class="summary-label">Tasa de Aprobación</div>
                    <div class="summary-value accent">
                      {{ gradeStats.passRate | number:'1.0-0' }}%
                    </div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>

  <!-- Grade Edit/Add Panel -->
  <div *ngIf="selectedStudent || selectedTabIndex === 1" class="edit-panel">
    <mat-card class="edit-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>{{ selectedStudent ? 'edit' : 'add' }}</mat-icon>
          {{ selectedStudent ? 'Editar' : 'Agregar' }} Calificación
        </mat-card-title>
        <mat-card-subtitle *ngIf="selectedStudent">
          {{ selectedStudent.estudiante.nombre }} {{ selectedStudent.estudiante.apellido }} - {{ selectedStudent.descripcion }}
        </mat-card-subtitle>
      </mat-card-header>
      
      <mat-card-content>
        <form [formGroup]="gradeForm" class="grade-form">
          <div class="form-row" *ngIf="!selectedStudent">
            <mat-form-field appearance="outline">
              <mat-label>Clase</mat-label>
              <mat-select formControlName="cursoDivisionMateriaId">
                <mat-option *ngFor="let class of myClasses" [value]="class.id">
                  {{ getClassDisplayName(class) }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Estudiante</mat-label>
              <mat-select formControlName="usuarioId">
                <!-- This would need to be populated based on selected class -->
                <mat-option value="">Seleccionar estudiante...</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Tipo de Evaluación</mat-label>
              <mat-select formControlName="tipoEvaluacion">
                <mat-option *ngFor="let type of evaluationTypes.slice(1)" [value]="type.value">
                  {{ type.label }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Trimestre</mat-label>
              <mat-select formControlName="trimestre">
                <mat-option *ngFor="let trimester of trimesters.slice(1)" [value]="trimester.value">
                  {{ trimester.label }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Descripción</mat-label>
            <input matInput formControlName="descripcion" 
                   placeholder="Ej: Examen Primer Parcial, Trabajo Práctico 1...">
            <mat-error *ngIf="gradeForm.get('descripcion')?.hasError('required')">
              La descripción es requerida
            </mat-error>
          </mat-form-field>

          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Calificación</mat-label>
              <input matInput type="number" formControlName="calificacion" 
                     min="0" max="10" step="0.1">
              <span matSuffix>/{{ gradeForm.get('calificacionMaxima')?.value }}</span>
              <mat-error *ngIf="gradeForm.get('calificacion')?.hasError('required')">
                La calificación es requerida
              </mat-error>
              <mat-error *ngIf="gradeForm.get('calificacion')?.hasError('min')">
                La calificación mínima es 0
              </mat-error>
              <mat-error *ngIf="gradeForm.get('calificacion')?.hasError('max')">
                La calificación máxima es 10
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Calificación Máxima</mat-label>
              <input matInput type="number" formControlName="calificacionMaxima" 
                     min="1" max="100">
              <mat-error *ngIf="gradeForm.get('calificacionMaxima')?.hasError('required')">
                La calificación máxima es requerida
              </mat-error>
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Fecha de Evaluación</mat-label>
            <input matInput [matDatepicker]="evaluationDatePicker" formControlName="fechaEvaluacion">
            <mat-datepicker-toggle matSuffix [for]="evaluationDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #evaluationDatePicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Observaciones</mat-label>
            <textarea matInput formControlName="observaciones" 
                      rows="3" placeholder="Observaciones sobre la evaluación..."></textarea>
          </mat-form-field>
        </form>
      </mat-card-content>
      
      <mat-card-actions>
        <button mat-raised-button color="primary" 
                (click)="saveGrade()" 
                [disabled]="gradeForm.invalid">
          <mat-icon>save</mat-icon>
          {{ selectedStudent ? 'Actualizar' : 'Registrar' }}
        </button>
        <button mat-button (click)="cancelEdit()">
          <mat-icon>cancel</mat-icon>
          Cancelar
        </button>
      </mat-card-actions>
    </mat-card>
  </div>
</div>